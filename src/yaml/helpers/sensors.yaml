template:
  - sensor:
    - name: "EE Envoy Observed Large"
      unique_id: "ee_envoy_observed_large"
      state: "on"
      attributes:
        pc: "{{ states('input_datetime.ee_envoy_pc_reporting_time') }}"
        sp: "{{ states('input_number.ee_observed_solar_production') | float }}"
        hl: "{{ states('input_number.ee_observed_home_load') | float }}"
        tc: "{{ states('input_number.ee_observed_total_consumption') | float }}"
        nc: "{{ states('input_number.ee_observed_net_consumption') | float }}"
        bt: "{{ states('input_datetime.ee_envoy_battery_reporting_time') }}"
        bf: "{{ states('input_number.ee_observed_battery_flow') | float }}"
        bc: "{{ states('input_number.ee_observed_charge') | float | round(2) }}"
        ba: "{{ states('input_text.ee_observed_batteries') }}"
        sc: "{{ states('input_text.ee_observed_tariff_schedule') }}"
        gs: "{{ states('input_text.ee_observed_grid_status') }}"
        vs: "{{ states('input_text.ee_observed_vers') }}"
    - name: "EE HAJT"
      unique_id: "ee_hajt"
      state: !secret hajt 
    - name: "EE Desired Battery Reserve"
      unique_id: "ee_desired_battery_reserve"
      unit_of_measurement: "%"
      state: |-
        {% set SP = states('input_number.ee_observed_solar_production') | float / 1000 %}
        {% set v =  
            min(
              max(
                states('input_number.ee_observed_charge') | float - 
                  (1 if SP > 2000 else 0.5 if SP > 1600 or states('input_number.ee_hour_of_day') | int < 13 else 0 if SP > 1200 else -0.5 if SP > 800 else -1),
                states('input_number.ee_observed_tariff_battery_reserve') | float,
              ),
              98 -
              (   
                max(
                  -2,
                  (SP - 1800)/500
                )
              ),
              100
            )
        %}
        {% set i = v | int %}
        {{ i + (0 if v-i < 0.5 else 0.5) }}  

command_line:                                       
  - sensor:                                         
      name: "Get my IP"                             
      unique_id: "get_my_ip"
      command: /sbin/ip address show | fgrep '192.' | cut -d ' ' -f 6 | cut -d '/' -f 1
      value_template: "{{ value }}"
      scan_interval: 31556926 

